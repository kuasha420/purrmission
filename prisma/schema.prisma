generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ResourceMode {
  ONE_OF_N
  // TODO: extend with other modes in future if needed (e.g. TWO_OF_N, MAJORITY, etc.)
}

enum GuardianRole {
  OWNER
  GUARDIAN
}

enum ApprovalRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

model Resource {
  id        String       @id @default(uuid())
  name      String
  mode      ResourceMode @default(ONE_OF_N)
  apiKey    String
  createdAt DateTime     @default(now())

  // Optional linked 2FA account (one-to-one)
  totpAccountId String?      @unique
  totpAccount   TOTPAccount? @relation(fields: [totpAccountId], references: [id], onDelete: SetNull)

  guardians        Guardian[]
  approvalRequests ApprovalRequest[]
  fields           ResourceField[]

  // Backlink from Environment (one-to-one)
  environment Environment?

  @@index([apiKey])
}

/// A text field attached to a resource (e.g., password, API key).
/// Values are encrypted at rest using AES-256-GCM.
model ResourceField {
  id         String   @id @default(uuid())
  resourceId String
  name       String
  value      String   // Encrypted at rest
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, name])
  @@index([resourceId])
}


model Guardian {
  id            String       @id @default(uuid())
  resourceId    String
  discordUserId String
  role          GuardianRole @default(GUARDIAN)
  createdAt     DateTime     @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([discordUserId])
}

model ApprovalRequest {
  id          String                @id @default(uuid())
  resourceId  String
  status      ApprovalRequestStatus @default(PENDING)
  context     Json
  callbackUrl String? // nullable
  createdAt        DateTime              @default(now())
  expiresAt        DateTime?
  resolvedBy       String?
  resolvedAt       DateTime?
  discordMessageId String?
  discordChannelId String?

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([status])
}

model TOTPAccount {
  id                 String   @id @default(uuid())
  ownerDiscordUserId String
  accountName        String
  /// TOTP secret - encrypted at rest using AES-256-GCM in the application layer
  secret             String
  issuer             String?
  shared             Boolean  @default(false)
  backupKey          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Backlink from Resource (one-to-one)
  linkedResource Resource?

  @@unique([ownerDiscordUserId, accountName])
  @@index([ownerDiscordUserId])
  @@index([shared])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  resourceId  String?
  actorId     String?
  resolverId  String?
  status      String
  context     String?
  createdAt   DateTime @default(now())

  @@index([resourceId])
  @@index([actorId])
  @@index([createdAt])
}

enum AuthSessionStatus {
  PENDING
  APPROVED
  EXPIRED
  DENIED
  CONSUMED
}

model AuthSession {
  id          String            @id @default(uuid())
  deviceCode  String            @unique
  userCode    String            @unique
  status      AuthSessionStatus // PENDING, APPROVED, EXPIRED, DENIED
  userId      String? // Linked Discord User ID
  expiresAt   DateTime
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model ApiToken {
  id          String   @id @default(uuid())
  token       String   @unique // Hashed at rest
  userId      String   // Discord User ID
  name        String   // Device/Session name
  lastUsedAt  DateTime?
  expiresAt   DateTime  // Mandatory expiry
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([lastUsedAt])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String   // Discord User ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  environments Environment[]

  @@index([ownerId])
}

model Environment {
  id        String   @id @default(uuid())
  name      String
  slug      String
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Link to Resource for credentials
  resourceId String?   @unique
  resource   Resource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  @@unique([projectId, slug])
  @@index([projectId])
}
