generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ResourceMode {
  ONE_OF_N
  // TODO: extend with other modes in future if needed (e.g. TWO_OF_N, MAJORITY, etc.)
}

enum GuardianRole {
  OWNER
  GUARDIAN
}

enum ApprovalRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

model Resource {
  id        String       @id @default(uuid())
  name      String
  mode      ResourceMode @default(ONE_OF_N)
  apiKey    String
  createdAt DateTime     @default(now())

  // Optional linked 2FA account (one-to-one)
  totpAccountId String?      @unique
  totpAccount   TOTPAccount? @relation(fields: [totpAccountId], references: [id], onDelete: SetNull)

  guardians        Guardian[]
  approvalRequests ApprovalRequest[]
  fields           ResourceField[]

  @@index([apiKey])
}

/// A text field attached to a resource (e.g., password, API key).
/// Values are encrypted at rest using AES-256-GCM.
model ResourceField {
  id         String   @id @default(uuid())
  resourceId String
  name       String
  value      String   // Encrypted at rest
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, name])
  @@index([resourceId])
}


model Guardian {
  id            String       @id @default(uuid())
  resourceId    String
  discordUserId String
  role          GuardianRole @default(GUARDIAN)
  createdAt     DateTime     @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([discordUserId])
}

model ApprovalRequest {
  id          String                @id @default(uuid())
  resourceId  String
  status      ApprovalRequestStatus @default(PENDING)
  context     Json
  callbackUrl String? // nullable
  createdAt        DateTime              @default(now())
  expiresAt        DateTime?
  resolvedBy       String?
  resolvedAt       DateTime?
  discordMessageId String?
  discordChannelId String?

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([status])
}

model TOTPAccount {
  id                 String   @id @default(uuid())
  ownerDiscordUserId String
  accountName        String
  /// TOTP secret - encrypted at rest using AES-256-GCM in the application layer
  secret             String
  issuer             String?
  shared             Boolean  @default(false)
  backupKey          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Backlink from Resource (one-to-one)
  linkedResource Resource?

  @@unique([ownerDiscordUserId, accountName])
  @@index([ownerDiscordUserId])
  @@index([shared])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  resourceId  String?
  actorId     String?
  resolverId  String?
  status      String
  context     String?
  createdAt   DateTime @default(now())

  @@index([resourceId])
  @@index([actorId])
  @@index([createdAt])
}
